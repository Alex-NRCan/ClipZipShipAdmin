{% extends '_master.html' %}

{% block head %}
{{ super() }}
<script type="text/javascript">
    $(document).ready(function() {
        $(".submit_on_enter").keydown(function(e) {
            if (e.keyCode==13) {
                uiQueryQuality();
                return false;
            }
        });

        $("#cog_all").change((e) => {
            // Check/Uncheck all
            $(".cog-item").prop("checked", e.currentTarget.checked);
        });
    });

    function uiQueryMetadata(lang) {
        var queryingText = "Querying, please wait...";
        if (lang == "fr")
            queryingText = "Requête en cours, patientez svp...";
        $(".loading-message").html(queryingText)
        $(".result_wrapper_inner").addClass("hidden");
        $("#cogs_section").addClass("hidden");
        $("#feature_section").addClass("hidden");

        var res = queryMetadata($("#metadata_uuid").val(), function (res) {
            console.log(res);

            // Clear
            $(".loading-message").html("");
            $(".result_wrapper_inner").removeClass("hidden");
            $('#result_table tbody').empty();
            $('#result_table_cogs tbody').empty();
            $('#result_table_feature tbody').empty();
            $("#result_type").val("feature");

            // Add title rows
            addRow(lang, "Title English:", "Titre anglais:", "title_en", res.title_en);
            addRow(lang, "Title French:", "Titre français:", "title_fr", res.title_fr);

            addRow(lang, "Description English:", "Description anglaise:", "description_en", "");
            addRow(lang, "Description French:", "Description française:", "description_fr", "");

            // Add keywords rows
            addRow(lang, "Keywords English:", "Mot-clés anglais:", "keywords_en", res.keywords_en);
            addRow(lang, "Keywords French:", "Mot-clés français:", "keywords_fr", res.keywords_fr);

            // Add spatial reference id
            addRow(lang, "Spatial Reference:", "Référence spatiale:", "crs", res.srid);

            // Extent
            addRow(lang, "Extent:", "Étendu:", "extent", res.extent.west + "," + res.extent.south + "," + res.extent.east + "," + res.extent.north);

            // Extent
            addRow(lang, "Temporal Extent Begin:", "Étendu temporel début:", "temporal_extent_begin", res.temporal_extent["begin"]);
            addRow(lang, "Temporal Extent End:", "Étendu temporel fin:", "temporal_extent_end", res.temporal_extent["end"]);

            // Add row for the feature
            addRowFeature(((lang == "fr") ? "Nom de la collection:" : "Name of the collection:"), "name");
            addRowFeature(((lang == "fr") ? "Nom de la table:" : "Name of the table:"), "table-name");
            addRowFeature(((lang == "fr") ? "Nom du champ de l'identifiant:" : "Data id field:"), "data-id-field");
            addRowFeature(((lang == "fr") ? "Champs requêtables:" : "Data queryables:"), "data-queryables");

            // If any cogs
            if (res.cogs && res.cogs.length > 0) {
                // Add coverage format name
                //addRow(lang, "Format name:", "Nom du format:", "cov_format_name", getFormatName());

                $("#result_type").val("coverage");
                $('#cogs_section').removeClass("hidden");
                
                // For each cog
                $.each(res.cogs, (idx, c) => {
                    var year = c.name[lang].match(/\d/g);
                    year = year.join("");

                    var name = res.topic;
                    if (year > 0)
                        name += "-" + year;

                    // Add name row
                    addRowCog(idx, c.name[lang], c.url, ((lang == "fr") ? "Nom:" : "Name:"), "name", name);
                });
            }

            else {
                // Feature by default
                $('#feature_section').removeClass("hidden");
            }
        });
    }

    function onTypeChanged() {
        // Depending on the selection
        if ($("#result_type").val() == "feature") {
            $('#cogs_section').addClass("hidden");
            $('#feature_section').removeClass("hidden");
        }

        else {
            $('#cogs_section').removeClass("hidden");
            $('#feature_section').addClass("hidden");
        }
    }

    function getFormatName() {
        return "GTiff";
    }

    function addRow(lang, label_en, label_fr, className, inputValue) {
        // Add row
        var tr = document.createElement("tr");
        $('#result_table tbody').append(tr);

        // Add cell
        var td = document.createElement("td");
        td.className = "cell-label";
        $(tr).append(td);
        $(td).html(label_en);
        if (lang == 'fr')
            $(td).html(label_fr);
        
        // Add cell
        var td = document.createElement("td");
        td.className = "cell-value";
        $(tr).append(td);

        // Add input
        var inpt = document.createElement("input");
        inpt.className = "cell-value-input " + className;
        $(td).html(inpt);
        $(inpt).val(inputValue);
    }

    function addRowCog(idx_cog, label_cog, url_cog, label_name, className, inputValue) {
        // Add row
        var tr = document.createElement("tr");
        $('#result_table_cogs tbody').append(tr);

        // Add cell
        var td = document.createElement("td");
        $(tr).append(td);

        var checkbox = document.createElement("input");
        $(checkbox).attr("id", 'cog_' + idx_cog);
        $(checkbox).addClass("cog-item");
        $(checkbox).attr("type", "checkbox");
        $(checkbox).attr("value", url_cog);
        $(checkbox).attr("checked", "true");
        $(td).append(checkbox);

        var label = document.createElement("label");
        $(label).attr("for", 'cog_' + idx_cog);
        $(label).addClass("cog-item-label");
        $(label).text(label_cog);
        $(td).append(label);

        td = document.createElement("td");
        $(tr).append(td);
        var span = document.createElement("span");
        $(td).append(span);
        $(span).text(label_name);
        var inpt = document.createElement("input");
        inpt.className = "cell-value-cog-input " + className;
        $(td).html(inpt);
        $(inpt).val(inputValue);
    }

    function addRowFeature(label_name, className) {
        // Add row
        var tr = document.createElement("tr");
        $('#result_table_feature tbody').append(tr);

        // Add cell
        var td = document.createElement("td");
        $(tr).append(td);
        var span = document.createElement("span");
        $(span).text(label_name);
        $(td).append(span);

        td = document.createElement("td");
        $(tr).append(td);
        var inpt = document.createElement("input");
        inpt.className = "cell-value-feature-input " + className;
        $(td).html(inpt);
    }

    function uiAddCollection() {
        // Build the payload
        var payload ={};
        payload.type = $("#result_type").val();
        payload.metadata_uuid = $("#metadata_uuid").val();
        payload.parent_uuid = "17e4197a-a764-475d-ab67-a2fb920e2300"
        payload.title_en = $(".cell-value-input.title_en").val();
        payload.title_fr = $(".cell-value-input.title_fr").val();
        payload.description_en = $(".cell-value-input.description_en").val();
        payload.description_fr = $(".cell-value-input.description_fr").val();
        payload.keywords_en = $(".cell-value-input.keywords_en").val().split(",");
        payload.keywords_fr = $(".cell-value-input.keywords_fr").val().split(",");
        payload.crs = parseInt($(".cell-value-input.crs").val());
        payload.extent_bbox = $(".cell-value-input.extent").val().split(",").map((x) => {return parseFloat(x);});
        payload.extent_crs = "http://www.opengis.net/def/crs/OGC/1.3/CRS84";
        payload.extent_temporal_begin = $(".cell-value-input.temporal_extent_begin").val();
        payload.extent_temporal_end = $(".cell-value-input.temporal_extent_end").val();

        payload.geom_crs = 4617;
        payload.geom_wkt = "POLYGON((-113.43 53.51, -113.43 53.59, -113.22 53.59, -113.22 53.51, -113.43 53.51))";
        
        // Depending on what kind of collection we're adding
        if ($("#result_type").val() == "coverage") {
            // If any cogs
            if ($(".cog-item:checked").length > 0) {
                // Add GTiff
                payload.cov_format_name = "GTiff";

                // For each checked cog
                var cogs = [];
                $(".cog-item:checked").each((idx, cogItem) => {
                    cogs.push({
                        name: $(".cell-value-cog-input.name", $(cogItem).parents("tr")[0]).val(),
                        cov_data: $(cogItem).val()
                    });
                });

                // Validate the cogs
                var valcogs = {};
                var allUnique = true;
                $(cogs).each((idx, cogItem) => {
                    if (valcogs[cogItem.name])
                        allUnique = false;
                    valcogs[cogItem.name] = true;
                });
                
                // If all unique names
                if (allUnique) {
                    // Proceed for each cog
                    $(cogs).each((idx, cogItem) => {
                        // Add to payload
                        payload.name = cogItem.name;
                        payload.cov_data = cogItem.cov_data;

                        addCollection(payload, function(res) {
                            alert("Collection(s) added.");
                        }, function(err) {
                            alert(err);
                        });
                    });
                }

                else {
                    alert("Make sure all collection names are unique");
                }
            }

            else {
                alert("No coverage files to add");
            }
        }

        else {
            // Add to payload
            payload.name = $(".cell-value-feature-input.name").val();
            payload.table_name = $(".cell-value-feature-input.table-name").val();
            payload.table_id_field = $(".cell-value-feature-input.data-id-field").val();
            var dq = $(".cell-value-feature-input.data-queryables").val();
            payload.table_queryables = dq.split(",").map((itm) => { return itm.trim(); });

            addCollection(payload, function(res) {
                alert("Collection added.");
            }, function(err) {
                alert(err);
            });
        }
    }
</script>
{% endblock %}

{% block nrcanheadercontent %}
{% if lang == 'fr' %}
<h1 property="name" id="wb-cont">Ajouter une collection</h1>
<p>Inscrivez l'identifiant UID à utiliser pour le pré-remplissage du formulaire.</p>
{% else %}
<h1 property="name" id="wb-cont">Add a Collection</h1>
<p>Type the Metadata UID to use in order to pre-fill the form.</p>
{% endif %}
<div>
    <input id="metadata_uuid" type="text" placeholder="{UUID}" class="submit_on_enter"
           value="62de5952-a5eb-4859-b086-22a8ba8024b8" style="width:90%;"/>
    <div class="small-notes">
        <p>Examples:<br/>
            Coverage: 62de5952-a5eb-4859-b086-22a8ba8024b8<br/>
            Feature: 0313f880-492c-4f4e-95ef-f53e4216576d<br/>
        </p>
        <div class="query-parameters">
            {% if lang == 'fr' %}
            <div>
                <input type="button" value="Pré-remplir" onclick="uiQueryMetadata('{{lang}}');"/>
            </div>
            {% else %}
            <div>
                <input type="button" value="Pre-fill" onclick="uiQueryMetadata('{{lang}}');"/>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block nrcanbody %}

<div id="result_wrapper" class="result_wrapper">
    <div class="loading-message"></div>

    <div class="result_wrapper_inner hidden">
        <div>
            <label>TYPE:</label>
            <select id="result_type" onchange="onTypeChanged(event);">
                {% if lang == 'fr' %}
                <option value="feature">Vecteur</option>
                <option value="coverage">Couverture</option>
                {% else %}
                <option value="feature">Feature</option>
                <option value="coverage">Coverage</option>
                {% endif %}
            </select>
        </div>

        <div id="common_header" class="common-header"><strong>INFORMATION:</strong>
        <table id="result_table">
            <thead></thead>
            <tbody></tbody>
        </table>

        <div id="cogs_section">
            <div id="cogs_header" class="cogs-header"><strong>COGS:</strong>
            </div>
            <div class="cog-check-all-section">
                <input id="cog_all" type="checkbox" checked="checked" />
                {% if lang == 'fr' %}
                <label for="cog_all">Cocher tous</label>
                {% else %}
                <label for="cog_all">Check all</label>
                {% endif %}
            </div>

            <table id="result_table_cogs">
                <thead></thead>
                <tbody></tbody>
            </table>
        </div>

        <div id="feature_section">
            <div id="feature_header" class="feature-header"><strong>FEATURE:</strong>
            </div>
            <table id="result_table_feature">
                <thead></thead>
                <tbody></tbody>
            </table>
        </div>

        <div class="bottom">
            {% if lang == 'fr' %}
            <input type="button" value="Ajouter" onclick="uiAddCollection()" />
            {% else %}
            <input type="button" value="Add" onclick="uiAddCollection()" />
            {% endif %}
        </div>
    </div>
    
</div>

{% endblock %}

